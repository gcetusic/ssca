<script type="text/javascript" src="{{ STATIC_URL }}js/jstz.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript">
var center_latitude = {{ gmap.center.0 }};
var center_longitude = {{ gmap.center.1 }};
var map_zoom = {{ gmap.zoom }};
var min_zoom = {{ gmap.minzoom }};
var gmaps_viewer = "{% url gmaps_viewer %}";
var marker_info = "{% url marker_info %}";
</script>

<noscript><b>JavaScript must be enabled in order for you to use Google Maps.</b>
    However, it seems JavaScript is either disabled or not supported by your browser.
    To view Google Maps, enable JavaScript by changing your browser options, and then
    try again.
</noscript>

<script type="text/javascript">
    window.onload = loadScript;

    var markersArray = [];

    function initialize() {
        var mapOptions = {
            center: new google.maps.LatLng(center_latitude, center_longitude),
            zoom: map_zoom,
            minZoom: min_zoom,
            mapTypeId: google.maps.MapTypeId.SATELLITE
        };
        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        google.maps.event.addListener(map, 'idle', getMarkers);

        function getMarkers() {
            var center = map.getCenter().lat();
            var bounds = map.getBounds();
            var ne = bounds.getNorthEast();
            var sw = bounds.getSouthWest();
            var boundaries = {
                "north": ne.lat(),
                "south": sw.lat(),
                "east": ne.lng(),
                "west": sw.lng(),
                "zoom": map.getZoom(),
                "center": map.getCenter().lng()
            }

            $.ajax({
                async: false,
                type: "POST",
                url: gmaps_viewer,
                dataType: "json",
                data: boundaries,
                success: function(data) {
                    clearOverlays();
                    deleteOverlays();
                    data.forEach(function(item) {
                        addMarker(
                            new google.maps.LatLng(item.position[0], item.position[1]),
                            item.title,
                            item.is_cluster,
                            item.id,
                            item.category
                        );
                    });
                    showOverlays();
                }
            });
        }

        function getTimezoneName() {
            timezone = jstz.determine();
            return timezone.name();
        }


        function prettyData(data) {
            var string = data.name + '<br />' + data.date + '<br />' + data.position;
            return string
        }

        function addMarker(position, title, is_cluster, id, category) {
            marker = new google.maps.Marker({
                position: position,
                map: map,
            });
            if ($("#filter input[value='" + category + "']").prop("checked") == false) {
                marker.setVisible(false);
            }
            marker.id = id;
            marker.is_cluster = is_cluster;
            marker.category = category;
            markersArray.push(marker);
        }

        // Removes the overlays from the map, but keeps them in the array
        function clearOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    markersArray[i].setMap(null);
                }
            }
        }

        // Shows any overlays currently in the array
        function showOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    if (markersArray[i].is_cluster) {
                        google.maps.event.addListener(markersArray[i], 'click', function() {
                            map.setZoom(map.getZoom()+1);
                            map.panTo(this.getPosition());
                        });
                    }
                    else { (function(marker) {
                        google.maps.event.addListener(marker, 'click', function () {
                            $.ajax({
                                async: false,
                                type: "POST",
                                url: marker_info,
                                dataType: "json",
                                data: {
                                    "id": marker.id,
                                    "category": marker.category,
                                    "timezone": getTimezoneName()
                                },
                                success: function (data) {
                                    infowindow = new google.maps.InfoWindow();
                                    infowindow.setContent(prettyData(data));
                                    infowindow.open(map, marker);
                                }
                            });
                        });
                    })(markersArray[i]);}
                }
            }
        }

        // Deletes all markers in the array by removing references to them
        function deleteOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    markersArray[i].setMap(null);
                }
                markersArray.length = 0;
            }
        }

        function show(category) {
            for (var i=0; i<markersArray.length; i++) {
                if (markersArray[i].category == category) {
                    markersArray[i].setVisible(true)
                }
            }
        }

        // == hides all markers of a particular category, and ensures the checkbox is cleared ==
        function hide(category) {
            for (var i=0; i<markersArray.length; i++) {
                if (markersArray[i].category == category) {
                    markersArray[i].setVisible(false);
                }
            }
        }


        $(document).ready(function() {
            $("input[name='filter']").prop("checked", true);
            $("input[name='filter']").live('click', function () {
                if ($(this).is(":checked")) {
                    show(this.value);
                }
                else {
                    hide(this.value);
                }
            });
        });
    };

    function loadScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "http://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&sensor=true&callback=initialize";
        document.body.appendChild(script);
    }
</script>


<div class="content">
    <div id="map_canvas" style="width:900px; height:600px"></div>
</div>


<div class="controls">
    <form id="filter">
        <input type="checkbox" name="filter" value="friends">My friends</input><br />
        <input type="checkbox" name="filter" value="members">All members</input><br />
        <input type="checkbox" name="filter" value="guides">Port Guides</input><br />
        <input type="checkbox" name="filter" value="stations">Cruising Stations</input>
    </form>
</div>
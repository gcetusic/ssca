<link href="{{ STATIC_URL }}bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">
<link href="{{ STATIC_URL }}css/locator.css" rel="stylesheet" media="screen">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="{{ STATIC_URL }}bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jstz.js"></script>
<script type="text/javascript">
var center_latitude = {{ gmap.center.0 }};
var center_longitude = {{ gmap.center.1 }};
var map_zoom = {{ gmap.zoom }};
var min_zoom = {{ gmap.minzoom }};
var gmaps_viewer = "{% url gmaps_viewer %}";
var marker_info = "{% url marker_info %}";
var member_finder = "{% url member_finder %}";
var searchqueue = [];
</script>

<noscript><b>JavaScript must be enabled in order for you to use Google Maps.</b>
    However, it seems JavaScript is either disabled or not supported by your browser.
    To view Google Maps, enable JavaScript by changing your browser options, and then
    try again.
</noscript>

<script type="text/javascript">
    window.onload = loadScript;

    var markersArray = [];

    function initialize() {
        var mapOptions = {
            center: new google.maps.LatLng(center_latitude, center_longitude),
            zoom: map_zoom,
            minZoom: min_zoom,
            mapTypeId: google.maps.MapTypeId.SATELLITE     
        };
        var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        google.maps.event.addListener(map, 'idle', getMarkers);

        var overlayMap = new google.maps.Map(
            document.getElementById('overlayMap'),
            {
                mapTypeId: google.maps.MapTypeId.ROADMAP, // Always show roadmap
                disableDefaultUI: true, // Turn off the controls
                scrollwheel: false, // Disable scrollwheel zooming
                disableDoubleClickZoom: true,
                center: new google.maps.LatLng(center_latitude, center_longitude),
                zoom: map_zoom,
            }
        );

        var translucentBox = new google.maps.Polygon({
            strokeColor: "#4444BB",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#4444BB",
            fillOpacity: 0.25
        });

        var transparentBox = new google.maps.Polygon({
            strokeColor: "#4444BB",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#4444BB",
            fillOpacity: 0.01
        });
        transparentBox.setMap(overlayMap);

        function pathFromBounds(bounds) {
            var northEastCorner = bounds.getNorthEast();
            var southWestCorner = bounds.getSouthWest();
            var northEastLat = northEastCorner.lat();
            var northEastLng = northEastCorner.lng();
            var southWestLat = southWestCorner.lat();
            var southWestLng = southWestCorner.lng();
            var southEastCorner = new google.maps.LatLng(southWestLat, northEastLng);
            var northWestCorner = new google.maps.LatLng(northEastLat, southWestLng);

            return [
                northEastCorner,
                southEastCorner,
                southWestCorner,
                northWestCorner,
                northEastCorner
            ];
        }

        function updateOverlayMapCenter() {
            var newCenter = map.getCenter();
            if (overlayMap.getCenter() !== newCenter) {
              overlayMap.panTo(newCenter);
            }
        }

        google.maps.event.addListener(map, 'bounds_changed', function () {
            var newBounds = map.getBounds();
            var path = [];
            if (newBounds !== undefined) {
                var mapWidth = null;
                var mapHeight = null;
                (function () {
                    var northEastCorner = newBounds.getNorthEast();
                    var southWestCorner = newBounds.getSouthWest();
                    var northEastLat = northEastCorner.lat();
                    var northEastLng = northEastCorner.lng();
                    var southWestLat = southWestCorner.lat();
                    var southWestLng = southWestCorner.lng();

                    mapHeight = Math.abs(180 + northEastLat - southWestLat) - 180;
                    mapWidth = Math.abs(360 + northEastLng - southWestLng) - 360;
                })();

                var overlayMapHeight = null;
                var overlayMapWidth = null;
                (function () {
                    var overlayBounds = overlayMap.getBounds();
                    var northEastCorner = overlayBounds.getNorthEast();
                    var southWestCorner = overlayBounds.getSouthWest();
                    var northEastLat = northEastCorner.lat();
                    var northEastLng = northEastCorner.lng();
                    var southWestLat = southWestCorner.lat();
                    var southWestLng = southWestCorner.lng();

                    overlayMapHeight = Math.abs(180 + northEastLat - southWestLat) - 180;
                    overlayMapHeight = overlayMapHeight / 2;
                    overlayMapWidth = Math.abs(360 + northEastLng - southWestLng) - 360;
                })();

                var heightOverage = (overlayMapHeight - mapHeight);
                var widthOverage = (overlayMapWidth - mapWidth);
                var margin = 0.2;
                var divisor = (2 + 2 * margin);
                var wayTooBig = false;
                if (
                    // margin of one means zoom in when overage is big enough that 
                    // zooming in would leave > half of width
                    // which would be when overage is > three quarters width

                    // margin of zero mean zoom in when overage is > half width
                    (widthOverage > (divisor - 1) * (overlayMapWidth / divisor)) &&
                    (heightOverage > (divisor - 1) * (overlayMapHeight / divisor))
                ) {
                    //FIXME: sometimes it isn't enough to change by only 1.
                    overlayMap.setZoom(overlayMap.getZoom() + 1);
                } else if (
                    // margin of one means, zoom out when overage is < half width
                    // margin of half means zoom out when overage is < quarter width
                    // margin of zero means zoom out when overage is < 0
                    (widthOverage < margin * overlayMapWidth / 2) ||
                    (heightOverage < margin * overlayMapHeight / 2)
                ) {
                    var overlayZoom = overlayMap.getZoom();
                    if (overlayZoom > 0) {
                      //FIXME: sometimes it isn't enough to change by only 1.
                        overlayMap.setZoom(overlayZoom - 1);
                    } else {
                      wayTooBig = true;
                    }
                }
                if (wayTooBig === false) {
                    path = pathFromBounds(newBounds);
                }
            }
            translucentBox.setPath(path);
        });

        function degToRad(degrees) {
            return degrees * Math.PI / 180;
        }

        function latToY(latitude) {
            var lat = degToRad(latitude);
            return Math.log(Math.tan(lat) + 1 / Math.cos(lat));
        }

        function radToDeg(radians) {
            return radians * 180 / Math.PI;
        }

        function yToLat(y) {
            var angle = 2 * Math.atan(Math.pow(Math.E, y)) - Math.PI / 2;
            return radToDeg(angle);
        }

        google.maps.event.addListener(overlayMap, 'bounds_changed', function () {
            var mapBounds = map.getBounds();
            if (mapBounds !== undefined) {
                var northEastCorner = mapBounds.getNorthEast();
                var southWestCorner = mapBounds.getSouthWest();
                var northEastLat = northEastCorner.lat();
                var northEastLng = northEastCorner.lng();
                var southWestLat = southWestCorner.lat();
                var southWestLng = southWestCorner.lng();

                var mapCenter = map.getCenter();
                var overlayCenter = overlayMap.getCenter();
                var lngDelta = overlayCenter.lng() - mapCenter.lng();
                northEastLng += lngDelta;
                southWestLng += lngDelta;

                var overlayMapBounds = overlayMap.getBounds();
                var overlayTopLat = overlayMapBounds.getNorthEast().lat();
                var overlayBottomLat = overlayMapBounds.getSouthWest().lat();
                var overlayTop = latToY(overlayTopLat);
                var overlayBottom = latToY(overlayBottomLat);
                var overlayHeight = Math.abs(overlayTop - overlayBottom);
                var mapHeight = Math.abs(latToY(northEastLat) - latToY(southWestLat));

                var bottomLatDelta = overlayBottom + (overlayHeight - mapHeight) / 2;
                var topLatDelta = overlayTop - (overlayHeight - mapHeight) / 2;
                northEastLat = yToLat(topLatDelta);
                southWestLat = yToLat(bottomLatDelta);

                var sw = new google.maps.LatLng(southWestLat, southWestLng);
                var se = new google.maps.LatLng(southWestLat, northEastLng);
                var ne = new google.maps.LatLng(northEastLat, northEastLng);
                var nw = new google.maps.LatLng(northEastLat, southWestLng);
                transparentBox.setPath([sw, nw, ne, se, sw]);
            }
        });

        google.maps.event.addListener(map, 'zoom_changed', function () {
            var newZoom = Math.max(map.getZoom() - 4, 0);
            if (overlayMap.getZoom() !== newZoom) {
                overlayMap.setZoom(newZoom);
            }
        });

        var mapDragInProgress = false;
        var panHasBegun = false;

        google.maps.event.addListener(map, 'center_changed', function () {
            if ((mapDragInProgress === false) && (panHasBegun === false)) {
                updateOverlayMapCenter();
            }
        });

        google.maps.event.addListener(map, 'idle', function () {
            if (panHasBegun === true) {
                panHasBegun = false;
                mapDragInProgress = false;
            }
        });

        google.maps.event.addListener(map, 'dragstart', function () {
            panHasBegun = false;
            mapDragInProgress = true;
        });

        google.maps.event.addListener(map, 'dragend', function () {
            updateOverlayMapCenter();
            mapDragInProgress = false;
        });

        google.maps.event.addListener(overlayMap, 'dragstart', function () {
            panHasBegun = false;
            mapDragInProgress = true;
        });

        google.maps.event.addListener(overlayMap, 'dragend', function () {
            panHasBegun = true;
            var newCenter = overlayMap.getCenter();
            if (map.getCenter() !== newCenter) {
              map.panTo(newCenter);
            }
        });

        google.maps.event.addListener(overlayMap, 'dblclick', function (mEvent) {
            mapDragInProgress = true;
            overlayMap.panTo(mEvent.latLng);
            map.panTo(mEvent.latLng);
        });

        google.maps.event.addListener(map, 'maptypeid_changed', function () {
            overlayMap.setOptions({mapTypeId: map.getMapTypeId()});
        });

        // // Set map's properties now that all bindings and listeners are set up.
        // map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
        // map.setZoom(8); // This will trigger a zoom_changed on the map
        // var defaultCenter = new google.maps.LatLng(41.889, -87.629);
        // map.setCenter(defaultCenter);

        overlayMap.setZoom(0);
        overlayMap.setCenter(new google.maps.LatLng(center_latitude, center_longitude));

        function getTimezoneName() {
            timezone = jstz.determine();
            return timezone.name();
        }

        function getMarkers(time) {

            var time = time || 0;
            var center = map.getCenter().lat();
            var bounds = map.getBounds();
            var ne = bounds.getNorthEast();
            var sw = bounds.getSouthWest();
            var boundaries = {
                "north": ne.lat(),
                "south": sw.lat(),
                "east": ne.lng(),
                "west": sw.lng(),
                "zoom": map.getZoom(),
                "center": map.getCenter().lng(),
                "timezone": getTimezoneName(),
                "time": time
            }

            $.ajax({
                async: false,
                type: "POST",
                url: gmaps_viewer,
                dataType: "json",
                data: boundaries,
                success: function(data) {
                    clearOverlays();
                    deleteOverlays();
                    data.forEach(function(item) {
                        addMarker(
                            new google.maps.LatLng(item.position[0], item.position[1]),
                            item.title,
                            item.is_cluster,
                            item.id,
                            item.category
                        );
                    });
                    showOverlays();
                }
            });
        }


        function prettyData(data, category) {
            var string;
            if (category=='members') {
                string = data.name + '<br />' + data.date + '<br />' + data.position;
            }
            else if (category=='guides') {
                string = data.title + '<br />' + data.date + '<br />' + data.author + '<br />' + data.portname;
            }
            else if (category=='stations') {
                string = data.name + '<br />' + data.phone + '<br />' + data.email +'<br />' + data.portname;
            }
            return string;
        }

        function addMarker(position, title, is_cluster, id, category) {
            marker = new google.maps.Marker({
                position: position,
                map: map,
            });
            if ($("#type-filter input[value='" + category + "']").prop("checked") == false) {
                marker.setVisible(false);
            }

            marker.id = id;
            marker.is_cluster = is_cluster;
            marker.category = category;
            markersArray.push(marker);
        }

        // Removes the overlays from the map, but keeps them in the array
        function clearOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    markersArray[i].setMap(null);
                }
            }
        }

        // Shows any overlays currently in the array
        function showOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    if (markersArray[i].is_cluster) {
                        google.maps.event.addListener(markersArray[i], 'click', function() {
                            map.setZoom(map.getZoom()+1);
                            map.panTo(this.getPosition());
                        });
                    }
                    else { (function(marker) {
                        google.maps.event.addListener(marker, 'click', function () {
                            $.ajax({
                                async: false,
                                type: "POST",
                                url: marker_info,
                                dataType: "json",
                                data: {
                                    "id": marker.id,
                                    "category": marker.category,
                                    "timezone": getTimezoneName()
                                },
                                success: function (data) {
                                    infowindow = new google.maps.InfoWindow();
                                    infowindow.setContent(prettyData(data, marker.category));
                                    infowindow.open(map, marker);
                                }
                            });
                        });
                    })(markersArray[i]);}
                }
            }
        }

        // Deletes all markers in the array by removing references to them
        function deleteOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    markersArray[i].setMap(null);
                }
                markersArray.length = 0;
            }
        }

        function show(category) {
            for (var i=0; i<markersArray.length; i++) {
                if (markersArray[i].category == category) {
                    markersArray[i].setVisible(true)
                }
            }
        }

        // == hides all markers of a particular category, and ensures the checkbox is cleared ==
        function hide(category) {
            for (var i=0; i<markersArray.length; i++) {
                if (markersArray[i].category == category) {
                    markersArray[i].setVisible(false);
                }
            }
        }

        $(document).ready(function() {
            $("#type-filter input[name='type']").prop("checked", true);
            $("#time-filter input[value='current']").prop("checked", true);
            $("#type-filter input[name='type']").live('click', function () {
                if ($(this).is(":checked")) {
                    show(this.value);
                }
                else {
                    hide(this.value);
                }
            });

            $("#time-filter input[name='time']").change(function () {
                var time;
                if ($(this).val() == 'current') {
                    time = 0;
                }
                if ($(this).val() == 'recent') {
                    time = 30;
                }
                getMarkers(time);
            });

            var searchqueue = [];
            setInterval(function () {
                if (searchqueue.length > 0) {
                text = searchqueue.pop();
                text.call();
                searchqueue = [];
                }
            }, 2000);

            var wrapFunction = function(fn, context, params) {
                return function() {
                    fn.apply(context, params);
                };
            }

            var search_results;
            function find(query, process) {
                var funsearch = function (query, process) {
                    $.ajax({
                        type: "POST",
                        url: member_finder,
                        data: {
                            "search": query,
                            "timezone": getTimezoneName()
                        },
                        dataType: "json",
                        success: function (results) {
                            var resultsArray = new Array;
                            if (results.length <= 20) {
                                search_results = results;
                                results.forEach(function (item, index) {
                                    result = "<div pk='" + index + "' style='visibility:hidden;'>" + "</div>"
                                        + item.fields.person.fields.user.fields.first_name + ' '
                                        + item.fields.person.fields.user.fields.last_name + ' ('
                                        + item.fields.person.fields.user.fields.email + ')'
                                    resultsArray.push(result);
                                });
                                process(resultsArray);
                            }
                        }
                    });
                };
                searchqueue.push(wrapFunction(funsearch, this, [query, process]));
            }

            $('#member_modal').modal({
                show: false,
                keyboard: false,
                backdrop: 'static'
            }).css({
                width: 'auto',
                'margin-left': function () {
                    return -($(this).width() / 2);
                }
            });

            $('#modal_find').on('click', function () {
                $('#member_modal').modal('hide');
                var member = search_results[$("#modal_search").attr("pk")];
                var center = new google.maps.LatLng(member.fields.latitude, member.fields.longitude);
                map.panTo(center);
                map.setZoom(5);
            })

            $('#member_modal').on('hidden', function () {
                $(this).find("input[type=text], textarea").val("");
            })

            // some functions aren't needed but included as templates
            $(".memberTypeahead").typeahead({
                minLength: 3,
                items: 10,
                source: find,
                updater: function(item) {
                    var wrapper= document.createElement('div');
                    wrapper.innerHTML= item;
                    var div= wrapper.firstChild;
                    $("#modal_search").attr("pk", $(div).attr('pk'));
                    return item.split("/div>")[1];
                },
                matcher: function(item) {
                    return true;
                },
                sorter: function(items) {
                    return items;
                }
            })
        });
    };

    function loadScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "http://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&sensor=true&callback=initialize";
        document.body.appendChild(script);
    }

</script>

<div class="content">
    <div id="map-canvas"></div>

    <div class="controls">
        <div class="controls-header">
            <div id="controls-left">Map controls</div>
            <div id="controls-right"><a href="#member_modal" role="button btn-primary" class="btn" data-toggle="modal">Find member</a></div>
        </div>

        <div class="control-buttons">
            <div id="type-filter">
                <input type="checkbox" name="type" value="friends">&nbspMy friends</input><br />
                <input type="checkbox" name="type" value="members">&nbspAll members</input><br />
                <input type="checkbox" name="type" value="guides">&nbspPort Guides</input><br />
                <input type="checkbox" name="type" value="stations">&nbspCruising Stations</input>
            </div>
            <div id="time-filter">
                <input type="radio" name="time" value="current">&nbspLast known locations</input><br />
                <input type="radio" name="time" value="recent">&nbspRecently updated locations</input><br />
                <br />
                Centered on ...coming soon...
            </div>
            <div id="overview_map">
                <div id="overlayMap"></div>
            </div>
        </div>
    </div>

    <div id="member_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="member_label" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">Members</h3>
        </div>
        <div class="modal-body">
            Search members: <input id="modal_search" type="text" class="memberTypeahead span6 search-query"></input>
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Close</a>
            <a href="#" id="modal_find" class="btn btn-primary">OK</a>
        </div>
    </div>
</div>